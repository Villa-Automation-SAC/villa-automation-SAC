<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Musica Trance — Player estilo Spotify</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e0f11;
    --panel:#121314;
    --accent:#1db954; /* verde tipo spotify */
    --muted:#9aa0a6;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: 'Inter', Arial, sans-serif;
    background: linear-gradient(180deg,#070708 0%, #0a0a0b 100%);
    color:#e6e6e6;
  }

  .app{
    display:flex;
    gap:24px;
    padding:28px;
    min-height:100vh;
  }

  /* Barra lateral (vacía similar a spotify) */
  .sidebar{
    width:260px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius:10px;
    padding:18px;
  }
  .sidebar h3{ margin:6px 0 18px 0; color:var(--muted); font-weight:500 }

  /* Panel principal */
  .player-area{
    flex:1;
    display:flex;
    gap:24px;
    align-items:flex-start;
  }

  .cover {
    width:360px;
    background:linear-gradient(135deg,#3a00ff44,#00ffa544);
    border-radius:12px;
    padding:18px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
  }
  .cover img{ width:100%; border-radius:8px; object-fit:cover; }
  .title{
    text-align:left;
    width:100%;
  }
  .title h1{ margin:8px 0 6px; font-size:28px; letter-spacing:-0.5px; }
  .title p{ margin:0; color:var(--muted) }

  .controls {
    margin-top:12px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .play-btn{
    width:68px; height:68px; border-radius:50%;
    background:var(--accent); border:none; cursor:pointer;
    display:grid; place-items:center; font-size:26px; color:#06110a;
    box-shadow: 0 8px 20px rgba(29,185,84,0.18);
  }
  .btn-ghost{
    background:transparent; border:1px solid rgba(255,255,255,0.06);
    color:var(--muted); padding:10px 12px; border-radius:8px; cursor:pointer;
  }

  .controls-col{
    display:flex; flex-direction:column; gap:8px; width:100%;
  }

  .sliders{ display:flex; gap:12px; align-items:center; }
  .slider { display:flex; align-items:center; gap:8px; }
  input[type="range"]{ appearance:none; width:220px; height:6px; background:var(--glass); border-radius:8px; }
  input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:var(--accent); box-shadow:0 2px 6px rgba(0,0,0,0.6) }

  .right-panel{
    flex:1;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    border-radius:10px;
    padding:18px;
    min-height:320px;
  }

  .download{
    margin-top:14px;
    display:inline-flex;
    gap:10px;
    align-items:center;
  }
  .download a{
    display:inline-block;
    padding:10px 16px;
    background:var(--accent);
    color:#06110a;
    text-decoration:none;
    border-radius:8px;
    font-weight:700;
  }

  footer{ position:fixed; left:0; right:0; bottom:0; padding:10px 28px; background:rgba(0,0,0,0.4); color:var(--muted); display:flex; justify-content:space-between; align-items:center }
  .badge{ font-size:13px; color:var(--muted) }
  @media(max-width:980px){
    .app{ flex-direction:column; padding:14px }
    .player-area{ flex-direction:column; align-items:center }
    .cover{ width:100% }
    .title h1{ text-align:center }
  }
</style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <h3>Tu Biblioteca</h3>
    <div style="color:var(--muted); font-size:14px">
      Reproduciendo: Trance — Instrumental
    </div>
    <hr style="margin:16px 0; border:0; height:1px; background:rgba(255,255,255,0.03)">
    <div style="color:var(--muted); font-size:13px">Listas recomendadas</div>
    <ul style="padding-left:14px; margin-top:8px; color:var(--muted)">
      <li>Electrónica 2025</li>
      <li>Trance Deep</li>
      <li>House Classics</li>
    </ul>
  </aside>

  <main class="player-area">
    <section class="cover">
      <!-- portada/imagen -->
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='600' height='600'><rect rx='12' width='100%' height='100%' fill='%23000'/><g><circle cx='300' cy='260' r='160' fill='%23004488'/><g fill='%2300ffdd' opacity='0.18'><rect x='60' y='40' width='440' height='440' rx='20' transform='rotate(25 300 300)'/></g></g></svg>" alt="Portada" />

      <div class="title">
        <h1>Trance — Instrumental (web)</h1>
        <p>Artista: Generador NINA-style • Duración: variable</p>
      </div>

      <div class="controls">
        <button class="play-btn" id="playBtn" title="Play">▶</button>
        <div class="controls-col">
          <div style="display:flex; gap:12px; align-items:center;">
            <div class="slider">
              <label style="font-size:13px; color:var(--muted)">BPM</label>
              <input id="bpm" type="range" min="100" max="150" value="138">
              <strong id="bpmVal" style="width:40px; text-align:center">138</strong>
            </div>
            <div class="slider">
              <label style="font-size:13px; color:var(--muted)">Vol</label>
              <input id="volume" type="range" min="0" max="1" step="0.01" value="0.85">
            </div>
          </div>

          <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
            <button class="btn-ghost" id="btnStop">Detener</button>
            <button class="btn-ghost" id="btnRandom">Variación Aleatoria</button>
            <div style="flex:1"></div>
            <div style="color:var(--muted); font-size:13px">Timbre:</div>
            <select id="timbre" style="background:transparent; color:inherit; border-radius:6px; border:1px solid rgba(255,255,255,0.04); padding:6px; margin-left:6px">
              <option value="sawtooth">Saw</option>
              <option value="square">Square</option>
              <option value="sine">Sine</option>
              <option value="triangle">Triangle</option>
            </select>
          </div>
        </div>
      </div>

      <div class="download">
        <div style="color:var(--muted); font-size:13px">Generar y descargar pista (WAV):</div>
        <a id="downloadLink" href="#" download="trance_web.wav">⬇ Descargar WAV</a>
      </div>
    </section>

    <aside class="right-panel">
      <h3 style="margin-top:0">Controles avanzados</h3>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
        <div style="width:120px; color:var(--muted)">Lead volume</div>
        <input id="leadVol" type="range" min="0" max="1" step="0.01" value="0.12">
      </div>

      <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
        <div style="width:120px; color:var(--muted)">Bass volume</div>
        <input id="bassVol" type="range" min="0" max="1" step="0.01" value="0.45">
      </div>

      <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
        <div style="width:120px; color:var(--muted)">Kick level</div>
        <input id="kickVol" type="range" min="0" max="1" step="0.01" value="1.0">
      </div>

      <p style="color:var(--muted)">Pulsa <strong>Variación Aleatoria</strong> para cambiar patrones, notas y timbres. La descarga generará un WAV de la pista actual (longitud configurable).</p>

      <hr style="margin:12px 0; border:0; height:1px; background:rgba(255,255,255,0.03)">

      <div style="color:var(--muted); font-size:13px; margin-bottom:8px">Previsualización de instrumentos</div>
      <button class="btn-ghost" id="previewLead">Play Lead</button>
      <button class="btn-ghost" id="previewBass">Play Bass</button>
      <button class="btn-ghost" id="previewKick">Play Kick</button>
    </aside>
  </main>
</div>

<footer>
  <div class="badge">Generador Trance • Inspirado (no idéntico) a NINA — Automatic Call</div>
  <div style="color:var(--muted)">Hecho con Web Audio API</div>
</footer>

<script>
/* ------------------------------
   Motor de audio: sintetizador
   ------------------------------ */
let audioCtx = null;
let masterGain = null;
let scheduledIntervals = [];
let isPlaying = false;

// estado / parámetros
const state = {
  bpm: 138,
  volume: 0.85,
  timbre: 'sawtooth',
  leadVol: 0.12,
  bassVol: 0.45,
  kickVol: 1.0,
};

// helpers UI
const bpmSlider = document.getElementById('bpm');
const bpmVal = document.getElementById('bpmVal');
const volumeSlider = document.getElementById('volume');
const timbreSel = document.getElementById('timbre');
const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('btnStop');
const randomBtn = document.getElementById('btnRandom');
const downloadLink = document.getElementById('downloadLink');

bpmSlider.addEventListener('input', ()=>{ state.bpm = Number(bpmSlider.value); bpmVal.textContent = state.bpm; });
volumeSlider.addEventListener('input', ()=>{ state.volume = Number(volumeSlider.value); if(masterGain) masterGain.gain.setValueAtTime(state.volume, audioCtx.currentTime) });
timbreSel.addEventListener('change', ()=> state.timbre = timbreSel.value);

document.getElementById('leadVol').addEventListener('input', (e)=> state.leadVol = Number(e.target.value));
document.getElementById('bassVol').addEventListener('input', (e)=> state.bassVol = Number(e.target.value));
document.getElementById('kickVol').addEventListener('input', (e)=> state.kickVol = Number(e.target.value));

playBtn.addEventListener('click', ()=> { if(!isPlaying) start(); else pause(); });
stopBtn.addEventListener('click', stopAll);
randomBtn.addEventListener('click', ()=> { randomizePattern(); });

// previews
document.getElementById('previewLead').addEventListener('click', previewLead);
document.getElementById('previewBass').addEventListener('click', previewBass);
document.getElementById('previewKick').addEventListener('click', previewKick);

/* --- generador de patrones simples --- */
let pattern = {
  // secuencias de 16 pasos
  leadNotes: [0,4,7,12,0,4,7,12, 0,4,7,12,0,4,7,12],
  bassNotes: [0,0,0,0, -12, -12,0,0, 0,0, -12,0, 0,0,0,0],
  hats:      [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
  kick:      [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0]
};

function randomizePattern(){
  // genera pequeñas variaciones aleatorias manteniendo feeling trance
  for(let i=0;i<16;i++){
    pattern.leadNotes[i] = [0,2,4,5,7,9,12][Math.floor(Math.random()*7)];
    pattern.bassNotes[i] = (Math.random()>0.75)? -12 : 0;
    pattern.hats[i] = Math.random() > 0.4 ? 1 : 0;
    pattern.kick[i] = (i%4===0) ? 1 : (Math.random()>0.9?1:0);
  }
  // feedback visual mínimo
  flashButton(randomBtn);
}

/* -------------- Playback control ------------- */
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = state.volume;
  masterGain.connect(audioCtx.destination);
}

let stepInterval = null;
let currentStep = 0;

function start(){
  initAudio();
  isPlaying = true;
  playBtn.textContent = "⏸";
  scheduleLoop();
}

function pause(){
  isPlaying = false;
  playBtn.textContent = "▶";
  clearScheduled();
}

function stopAll(){
  pause();
  currentStep = 0;
  clearScheduled();
}

function clearScheduled(){
  scheduledIntervals.forEach(id=> clearInterval(id));
  scheduledIntervals = [];
  if(stepInterval){ clearInterval(stepInterval); stepInterval=null; }
}

/* scheduleLoop: maneja pasos según BPM */
function scheduleLoop(){
  clearScheduled();
  const beat = 60 / state.bpm;      // duración negra
  const stepTime = beat/4;          // 16 pasos por compás
  const start = audioCtx.currentTime + 0.05;
  currentStep = 0;

  // función que ejecuta un paso
  function step(){
    const t = audioCtx.currentTime;
    playStep(currentStep, t);
    currentStep = (currentStep + 1) % 16;
  }
  // ejecutar inmediatamente y luego en intervalo
  step();
  stepInterval = setInterval(step, stepTime*1000);
  scheduledIntervals.push(stepInterval);
}

/* reproduce lo que debe sonar en un paso */
function playStep(stepIndex, t){
  // Kick
  if(pattern.kick[stepIndex]){
    playKick(t);
  }
  // Hat
  if(pattern.hats[stepIndex]){
    playHat(t);
  }
  // Bass (nota larga)
  if(pattern.bassNotes[stepIndex]!==0){
    const midi = 48 + pattern.bassNotes[stepIndex]; // C2 base
    const freq = midiToFreq(midi);
    playBass(freq, t);
  }
  // Lead (nota corta/arpegio)
  const leadNote = pattern.leadNotes[stepIndex];
  const leadFreq = midiToFreq(60 + leadNote); // C4 base
  playLead(leadFreq, t, stepIndex);
}

/* -------------- instrument builders ------------- */
function playLead(freq, time, step){
  // 2 osciladores en detune para chorus
  const oscA = audioCtx.createOscillator();
  const oscB = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();

  oscA.type = state.timbre;
  oscB.type = state.timbre;
  oscA.frequency.value = freq;
  oscB.frequency.value = freq * 1.0015; // ligero detune
  oscB.detune.value = 6;
  gain.gain.value = 0;

  filter.type = 'lowpass';
  filter.frequency.value = 2000 + (Math.sin(step*0.6)*400);

  const leadGain = audioCtx.createGain();
  leadGain.gain.value = state.leadVol;

  oscA.connect(filter);
  oscB.connect(filter);
  filter.connect(leadGain);
  leadGain.connect(masterGain);

  oscA.start(time);
  oscB.start(time);

  const dur = (60/state.bpm)/2; // semicorchea / corchea
  // envelope
  leadGain.gain.setValueAtTime(0.0001, time);
  leadGain.gain.exponentialRampToValueAtTime(state.leadVol, time + 0.01);
  leadGain.gain.exponentialRampToValueAtTime(0.0001, time + dur*0.9);

  oscA.stop(time + dur);
  oscB.stop(time + dur);
}

function playBass(freq, time){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sawtooth';
  osc.frequency.value = freq;
  gain.gain.value = 0.0001;

  const bassFilter = audioCtx.createBiquadFilter();
  bassFilter.type = 'lowpass';
  bassFilter.frequency.value = 800;

  const g = audioCtx.createGain();
  g.gain.value = state.bassVol;

  osc.connect(bassFilter);
  bassFilter.connect(g);
  g.connect(masterGain);

  osc.start(time);
  // envelope más largo
  gain.gain.setValueAtTime(0.0001, time);
  // small transient
  g.gain.setValueAtTime(state.bassVol, time);
  g.gain.exponentialRampToValueAtTime(0.0001, time + (60/state.bpm)*0.9);

  osc.stop(time + (60/state.bpm)*0.9);
}

function playKick(time){
  // Kick via sine sweep
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(160, time);
  osc.frequency.exponentialRampToValueAtTime(40, time + 0.12);

  gain.gain.setValueAtTime(state.kickVol, time);
  gain.gain.exponentialRampToValueAtTime(0.001, time + 0.12);

  osc.connect(gain).connect(masterGain);

  osc.start(time);
  osc.stop(time + 0.14);
}

function playHat(time){
  // hi-hat simple con ruido filtrado
  const bufferSize = audioCtx.sampleRate * 0.02;
  const noise = audioCtx.createBufferSource();
  const buf = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1)*0.5;
  noise.buffer = buf;

  const filt = audioCtx.createBiquadFilter();
  filt.type = 'highpass';
  filt.frequency.value = 7000;

  const g = audioCtx.createGain();
  g.gain.value = 0.08;

  noise.connect(filt);
  filt.connect(g);
  g.connect(masterGain);

  noise.start(time);
  noise.stop(time + 0.05);
}

/* ---- preview helpers ---- */
function previewLead(){ initAudio(); playLead(440, audioCtx.currentTime + 0.02, 0); }
function previewBass(){ initAudio(); playBass(55, audioCtx.currentTime + 0.02); }
function previewKick(){ initAudio(); playKick(audioCtx.currentTime + 0.02); }

function midiToFreq(m){
  return 440 * Math.pow(2, (m-69)/12);
}
function flashButton(el){
  el.style.transform = 'scale(0.98)';
  setTimeout(()=> el.style.transform = '', 120);
}

/* --------------------------
   Renderizar audio para WAV
   -------------------------- */
async function renderWav(durationSeconds = 60){
  // Renderiza OFFLINE la pista completa usando OfflineAudioContext
  const sampleRate = 44100;
  const offline = new OfflineAudioContext(2, sampleRate * durationSeconds, sampleRate);

  // Parámetros locales a render
  const bpm = state.bpm;
  const stepTime = (60/bpm)/4;
  const master = offline.createGain();
  master.gain.value = state.volume;
  master.connect(offline.destination);

  function o_midiToFreq(m){ return 440 * Math.pow(2, (m-69)/12); }

  // Timeline: recorrer pasos y escribir instrumentos programáticamente
  let t = 0;
  for(let stepIndex=0; stepIndex < Math.floor(durationSeconds / stepTime); stepIndex++){
    const s = stepIndex % 16;

    // kick
    if(pattern.kick[s]){
      // sine sweep
      const o = offline.createOscillator();
      const g = offline.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(160, t);
      o.frequency.exponentialRampToValueAtTime(40, t + 0.12);
      g.gain.setValueAtTime(state.kickVol, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
      o.connect(g).connect(master);
      o.start(t); o.stop(t + 0.14);
    }

    // hat
    if(pattern.hats[s]){
      // ruido corto
      const buf = offline.createBuffer(1, offline.sampleRate * 0.02, offline.sampleRate);
      const arr = buf.getChannelData(0);
      for(let i=0;i<arr.length;i++) arr[i] = (Math.random()*2-1)*0.5;
      const noise = offline.createBufferSource();
      noise.buffer = buf;
      const filt = offline.createBiquadFilter();
      filt.type = 'highpass';
      filt.frequency.value = 7000;
      const g = offline.createGain();
      g.gain.value = 0.08;
      noise.connect(filt); filt.connect(g); g.connect(master);
      noise.start(t); noise.stop(t + 0.05);
    }

    // bass
    if(pattern.bassNotes[s]!==0){
      const midi = 48 + pattern.bassNotes[s];
      const freq = o_midiToFreq(midi);
      const o = offline.createOscillator();
      o.type = 'sawtooth';
      o.frequency.value = freq;
      const g = offline.createGain();
      g.gain.setValueAtTime(state.bassVol, t);
      g.gain.exponentialRampToValueAtTime(0.0001, t + (60/bpm)*0.9);
      o.connect(g).connect(master);
      o.start(t); o.stop(t + (60/bpm)*0.9);
    }

    // lead
    const ln = pattern.leadNotes[s];
    const lf = o_midiToFreq(60 + ln);
    // two oscs detune
    const oa = offline.createOscillator();
    const ob = offline.createOscillator();
    oa.type = state.timbre;
    ob.type = state.timbre;
    oa.frequency.value = lf;
    ob.frequency.value = lf * 1.0015;
    const lg = offline.createGain();
    lg.gain.setValueAtTime(state.leadVol, t);
    lg.gain.exponentialRampToValueAtTime(0.0001, t + (60/bpm)/2 * 0.9 );
    const filt = offline.createBiquadFilter();
    filt.type = 'lowpass';
    filt.frequency.value = 2000 + (Math.sin(s*0.6)*400);
    oa.connect(filt); ob.connect(filt); filt.connect(lg); lg.connect(master);
    oa.start(t); ob.start(t); oa.stop(t + (60/bpm)/2); ob.stop(t + (60/bpm)/2);

    t += stepTime;
  }

  // Render
  const rendered = await offline.startRendering();
  // convertir AudioBuffer a WAV blob
  const wav = audioBufferToWav(rendered);
  const blob = new Blob([wav], { type: 'audio/wav' });
  const url = URL.createObjectURL(blob);
  return { blob, url };
}

// util: AudioBuffer -> WAV (PCM16)
function audioBufferToWav(buffer, opt){
  opt = opt || {}
  var numChannels = buffer.numberOfChannels
  var sampleRate = buffer.sampleRate
  var format = opt.float32 ? 3 : 1
  var bitDepth = format === 3 ? 32 : 16

  var result
  if (numChannels === 2) {
    result = interleave(buffer.getChannelData(0), buffer.getChannelData(1))
  } else {
    result = buffer.getChannelData(0)
  }

  return encodeWAV(result, numChannels, sampleRate, bitDepth)
}

function interleave(inputL, inputR){
  var length = inputL.length + inputR.length
  var result = new Float32Array(length)

  var index = 0
  var inputIndex = 0

  while (index < length){
    result[index++] = inputL[inputIndex]
    result[index++] = inputR[inputIndex]
    inputIndex++
  }
  return result
}

function encodeWAV(samples, numChannels, sampleRate, bitDepth){
  var bytesPerSample = bitDepth/8
  var blockAlign = numChannels * bytesPerSample

  var buffer = new ArrayBuffer(44 + samples.length * bytesPerSample)
  var view = new DataView(buffer)

  /* RIFF identifier */
  writeString(view, 0, 'RIFF')
  /* file length */
  view.setUint32(4, 36 + samples.length * bytesPerSample, true)
  /* RIFF type */
  writeString(view, 8, 'WAVE')
  /* format chunk identifier */
  writeString(view, 12, 'fmt ')
  /* format chunk length */
  view.setUint32(16, 16, true)
  /* sample format (raw) */
  view.setUint16(20, 1, true)
  /* channel count */
  view.setUint16(22, numChannels, true)
  /* sample rate */
  view.setUint32(24, sampleRate, true)
  /* byte rate (sampleRate * blockAlign) */
  view.setUint32(28, sampleRate * blockAlign, true)
  /* block align (channelCount * bytesPerSample) */
  view.setUint16(32, blockAlign, true)
  /* bits per sample */
  view.setUint16(34, bitDepth, true)
  /* data chunk identifier */
  writeString(view, 36, 'data')
  /* data chunk length */
  view.setUint32(40, samples.length * bytesPerSample, true)
  // write samples
  floatTo16BitPCM(view, 44, samples)

  return view
}

function floatTo16BitPCM(output, offset, input){
  for (var i = 0; i < input.length; i++, offset += 2){
    var s = Math.max(-1, Math.min(1, input[i]))
    output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true)
  }
}

function writeString(view, offset, string){
  for (var i = 0; i < string.length; i++){
    view.setUint8(offset + i, string.charCodeAt(i))
  }
}

/* conectar descarga al link */
downloadLink.addEventListener('click', async (e)=>{
  e.preventDefault();
  downloadLink.textContent = 'Generando... espera';
  downloadLink.style.pointerEvents = 'none';
  const duration = 45; // segundos por defecto
  const { blob, url } = await renderWav(duration);
  downloadLink.href = url;
  downloadLink.download = 'trance_web.wav';
  downloadLink.textContent = '⬇ Descargar WAV';
  downloadLink.style.pointerEvents = 'auto';
  // opcional: iniciar descarga automática
  // let a = document.createElement('a'); a.href = url; a.download = 'trance_web.wav'; a.click();
});

/* inicial pattern simple */
randomizePattern();

</script>
</body>
</html>
